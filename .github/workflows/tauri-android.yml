name: 'Android'

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        run: |
          # Use the latest installed NDK version (GitHub runners have one pre-installed)
          NDK_VERSION=$(ls -1 $ANDROID_HOME/ndk | sort -V | tail -1)
          if [ -z "$NDK_VERSION" ]; then
            echo "No NDK found, installing..."
            sdkmanager --install "ndk;27.0.12077973"
            NDK_VERSION="27.0.12077973"
          fi
          echo "Using NDK version: $NDK_VERSION"
          echo "NDK_HOME=$ANDROID_HOME/ndk/$NDK_VERSION" >> $GITHUB_ENV

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Initialize Tauri Android
        run: bunx tauri android init

      - name: Configure Rust for Android 16KB pages
        run: |
          mkdir -p .cargo
          echo '[target.aarch64-linux-android]' >> .cargo/config.toml
          echo 'rustflags = ["-C", "link-arg=-Wl,-z,max-page-size=16384"]' >> .cargo/config.toml

      - name: Setup Android Signing
        env:
          ANDROID_KEY_BASE64: ${{ secrets.ANDROID_KEY_BASE64 }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd src-tauri/gen/android
          
          # Skip if no signing key provided
          if [ -z "$ANDROID_KEY_BASE64" ]; then
            echo "⏭️ No signing key provided, skipping release signing setup"
            exit 0
          fi
          
          echo "🔐 Setting up Android release signing..."
          
          # 1. Create keystore.properties (per Tauri docs)
          echo "keyAlias=$ANDROID_KEY_ALIAS" > keystore.properties
          echo "password=$ANDROID_KEY_PASSWORD" >> keystore.properties
          base64 -d <<< "$ANDROID_KEY_BASE64" > $RUNNER_TEMP/keystore.jks
          echo "storeFile=$RUNNER_TEMP/keystore.jks" >> keystore.properties
          
          # 2. Replace empty signingConfigs {} with release config using Python
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('app/build.gradle.kts', 'r') as f:
              content = f.read()
          
          # Define the signingConfigs block (to be placed inside android { ... })
          signing_block = '''    signingConfigs {
            create("release") {
                val keystorePropertiesFile = rootProject.file("keystore.properties")
                val keystoreProperties = java.util.Properties()
                if (keystorePropertiesFile.exists()) {
                    keystoreProperties.load(java.io.FileInputStream(keystorePropertiesFile))
                }
                keyAlias = keystoreProperties["keyAlias"] as String
                keyPassword = keystoreProperties["password"] as String
                storeFile = file(keystoreProperties["storeFile"] as String)
                storePassword = keystoreProperties["password"] as String
            }
        }'''

          # Case 1: replace empty signingConfigs { } if it exists
          if re.search(r'signingConfigs\s*\{\s*\}', content):
              content, n = re.subn(r'signingConfigs\s*\{\s*\}', signing_block, content, count=1)
              print(f"Replaced empty signingConfigs block (count={n})")
          else:
              # Case 2: no signingConfigs at all, inject into android { } block
              def inject_into_android(match):
                  prefix = match.group(0)
                  return prefix + "\n" + signing_block + "\n"

              content, n = re.subn(r'android\s*\{', inject_into_android, content, count=1)
              print(f"Injected signingConfigs into android block (count={n})")
          
          # Add signingConfig to release buildType
          def add_signing(match):
              indent = match.group(1)
              return f'{indent}getByName("release") {{\n{indent}    signingConfig = signingConfigs.getByName("release")'
          
          content = re.sub(r'(\s*)getByName\("release"\)\s*\{', add_signing, content, count=1)
          
          with open('app/build.gradle.kts', 'w') as f:
              f.write(content)
          
          print("✅ build.gradle.kts configured for release signing")
          PYTHON_SCRIPT
          
          echo "=== Verification ==="
          echo "First 5 lines of build.gradle.kts:"
          head -5 app/build.gradle.kts
          echo ""
          echo "signingConfigs occurrences (with line numbers):"
          grep -n "signingConfigs" app/build.gradle.kts || echo "<no signingConfigs found>"

      - name: Build Tauri Android
        run: bunx tauri android build --apk true --aab true

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Memory-Player-Android-APK
          path: src-tauri/gen/android/app/build/outputs/apk/**/*.apk
          if-no-files-found: warn

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: Memory-Player-Android-AAB
          path: src-tauri/gen/android/app/build/outputs/bundle/**/*.aab
          if-no-files-found: warn
