name: "Generate Android Keystore"

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: 'Key alias name'
        required: true
        default: 'memory-player-upload'
      validity_days:
        description: 'Validity in days (10000 = ~27 years)'
        required: true
        default: '10000'
      org_name:
        description: 'Organization name'
        required: true
        default: 'Memory Player'
      country_code:
        description: 'Country code (2 letters)'
        required: true
        default: 'CN'

jobs:
  generate-keystore:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Random Password
        id: password
        run: |
          # Generate a secure random password
          PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 20)
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "ğŸ” Generated secure password (will be shown in output)"

      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore app-upload-key.jks \
            -keyalg RSA -keysize 2048 -validity ${{ github.event.inputs.validity_days }} \
            -alias ${{ github.event.inputs.key_alias }} \
            -dname "CN=${{ github.event.inputs.org_name }}, OU=Mobile, O=${{ github.event.inputs.org_name }}, L=Beijing, S=Beijing, C=${{ github.event.inputs.country_code }}" \
            -storepass "${{ steps.password.outputs.password }}" \
            -keypass "${{ steps.password.outputs.password }}"
          
          echo "âœ… Keystore generated successfully!"

      - name: Output Secrets Configuration
        run: |
          echo ""
          echo "=============================================="
          echo "ğŸ”‘ COPY THESE VALUES TO GITHUB SECRETS"
          echo "=============================================="
          echo ""
          echo "ğŸ“Œ ANDROID_KEY_ALIAS:"
          echo "${{ github.event.inputs.key_alias }}"
          echo ""
          echo "ğŸ“Œ ANDROID_KEY_PASSWORD:"
          echo "${{ steps.password.outputs.password }}"
          echo ""
          echo "ğŸ“Œ ANDROID_KEY_BASE64:"
          echo "ğŸ‘‡ğŸ‘‡ğŸ‘‡ COPY THE ENTIRE STRING BELOW ğŸ‘‡ğŸ‘‡ğŸ‘‡"
          base64 -w 0 app-upload-key.jks
          echo ""
          echo "ğŸ‘†ğŸ‘†ğŸ‘† COPY THE ENTIRE STRING ABOVE ğŸ‘†ğŸ‘†ğŸ‘†"
          echo ""
          echo "=============================================="
          echo "âš ï¸  IMPORTANT: Save these values NOW!"
          echo "    The keystore file will be deleted in 1 day."
          echo "    Store the password securely - you cannot recover it!"
          echo "=============================================="

      - name: Upload Keystore as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-keystore-backup
          path: app-upload-key.jks
          retention-days: 1
